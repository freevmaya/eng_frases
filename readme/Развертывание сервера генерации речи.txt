# Создайте директории для логов и сокетов
mkdir -p /var/log/audio-generator
mkdir -p /run/audio-generator

# Настройте права
chown -R nginx:nginx /var/log/audio-generator
chown -R nginx:nginx /run/audio-generator
chmod 755 /var/log/audio-generator
chmod 755 /run/audio-generator
---------------------------------------------------------------------------------------------------------

cd /home/vmaya/www/eng_frases/generator
python3.11 -m venv venv
source venv/bin/activate
---------------------------------------------------------------------------------------------------------

pip install --upgrade pip

# Создайте requirements.txt если его нет
cat > requirements.txt << 'EOF'
Flask==2.3.3
gtts==2.3.1
requests==2.31.0
gunicorn==21.2.0
EOF

# Установите зависимости
pip install -r requirements.txt
---------------------------------------------------------------------------------------------------------


audio-generator.service:

[Unit]
Description=Audio Generator API Service
After=network.target nginx.target
Requires=nginx.target

[Service]
Type=simple
User=nginx
Group=nginx
WorkingDirectory=/home/vmaya/www/eng_frases/generator

# Environment variables
Environment="PATH=/home/vmaya/www/eng_frases/generator/venv/bin"
Environment="PYTHONPATH=/home/vmaya/www/eng_frases/generator"
Environment="BASE_OUTPUT_DIR=/home/vmaya/www/eng_frases/public/data/audio_files_gtts"
Environment="JSON_FILE_PATH=/home/vmaya/www/eng_frases/public/data/en-ru.json"

# Команда запуска
ExecStart=/home/vmaya/www/eng_frases/generator/venv/bin/gunicorn \
          --workers 3 \
          --threads 2 \
          --bind unix:/run/audio-generator/audio-generator.sock \
          --timeout 120 \
          --access-logfile /var/log/audio-generator/access.log \
          --error-logfile /var/log/audio-generator/error.log \
          --log-level info \
          --chdir /home/vmaya/www/eng_frases/generator \
          wsgi:application

# Перезапуск при сбое
Restart=always
RestartSec=5

# Безопасность
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/home/vmaya/www/eng_frases/public/data/audio_files_gtts
ReadWritePaths=/var/log/audio-generator

# Лимиты
LimitNOFILE=65536
LimitNPROC=65536

[Install]
WantedBy=multi-user.target
------------------------------------------------------------------------------------------------

chown -R nginx:nginx /home/vmaya/www/eng_frases/public/data/audio_files_gtts
chmod -R 755 /home/vmaya/www/eng_frases/public/data/audio_files_gtts

chown -R nginx:nginx /home/vmaya/www/eng_frases/generator
chmod -R 755 /home/vmaya/www/eng_frases/generator

-----------------------------------------------------------------------------------------------
# Перезагрузите systemd
systemctl daemon-reload

# Запустите службу
systemctl start audio-generator

# Включите автозапуск
systemctl enable audio-generator

# Проверьте статус
systemctl status audio-generator

# Просмотр логов
journalctl -u audio-generator -f
----------------------------------------------------------------------------------------------
Nginx конфигурация api.vmaya.ru.conf

upstream audio_generator {
    server unix:/run/audio-generator/audio-generator.sock;
}

server {
    listen 80;
    server_name api.vmaya.ru;
    
    location / {
        proxy_pass http://audio_generator;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type,Authorization' always;
    }
}
----------------------------------------------------------------------------------------------

SSL 

Certificate is saved at: /etc/letsencrypt/live/api.vmaya.ru/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/api.vmaya.ru/privkey.pem